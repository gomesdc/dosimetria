<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dosimetria da pena</title>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="css/default.css"/>
    </head>
    <body>
        <div id="overlay" style="display:none;"></div>
        <div id="ajax-loading" style="display:none;">
            <img id="img-ajax-loading" src="css/ajax-loading.gif" alt="Loading"/>
        </div>
        <div class="wrap">
            <div class="container">
                <div class="jumbotron well-sm">
                    <h2>2ª CCR</h2>
                </div>
                <form onSubmit='return drawChart();' class="form-horizontal">
                    <div class="form-group">
                        <label for="tipo_droga" class="col-sm-2">Selecione a droga</label>
                        <div class="col-sm-3">
                            <select id="tipo_droga" onChange='getUnidadeMedidas();' class="form-control">
                                <option>CARREGANDO...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="unidade_medida" class="col-sm-2">Selecione a unidade de medida</label>
                        <div class="col-sm-3">
                            <select id="unidade_medida" class="form-control">
                                <option></option>
                            </select>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Filtros</legend>
                        <div class="form-group">
                            <label for="qt_minima" class="col-sm-2">Quantidade mínima</label>
                            <div class="col-sm-3">
                                <input id="qt_minima" type="number" class="form-control"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="qt_maxima" class="col-sm-2">Quantidade máxima</label>
                            <div class="col-sm-3">
                                <input id="qt_maxima" type="number" class="form-control"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tribunais" class="col-sm-2">Tribunais</label>
                            <div id="div_tribunais" class="col-sm-10"></div>
                        </div>
                    </fieldset>
                    <input type="submit" value="Gerar Gráficos" class="btn btn-primary"/>
                </form>

                <div id="chart_div"></div>
                <div id="table_div"></div>
            </div> <!-- FIm div container -->
        </div> <!-- FIm div wrap -->
        <div class="footer">
            <div class="container text-center">
                Ministério Público Federal<br/>
                Procuradoria da República no Município de Cachoeiro de Itapemirim/ES<br/>
                Desenvolvido por <a href="mailto:danielgomes@mpf.mp.br">Daniel da Cruz Gomes</a>
            </div>
        </div>
            <script type="text/javascript">
                // Carrega a biblioteca de visualização do google
                google.load("visualization", "1", {'packages':['corechart', 'table']});
                // Apos o carregamento executa a funcao
                google.setOnLoadCallback(getDrogasAndTribunais);
                
                // Recupera as drogas que constam na planilha
                function getDrogasAndTribunais(){
                    queryDrogas = new google.visualization.Query(
                    'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=1548055939');
                    queryDrogas.send(function(response){
                        if (response.isError()) {
                            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                            return;
                        }

                        var data = response.getDataTable();
                        var numRows = data.getNumberOfRows();
                        var options = '<option><\/option>';
                        for(var i = 0; i < numRows; i++ ){
                            options += '<option value="'+data.getValue(i, 0)+'">'+data.getValue(i, 0)+'</option>'
                        }
                        document.getElementById('tipo_droga').innerHTML = options;
                    });
                    
                    queryTribunais = new google.visualization.Query(
                    'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=1195586804');
                    queryTribunais.send(function(response){
                        if (response.isError()) {
                            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                            return;
                        }

                        var data = response.getDataTable();
                        var numRows = data.getNumberOfRows();
                        var inputs = '';
                        for(var i = 0; i < numRows; i++ ){
                            inputs += '<label class="checkbox-inline" style="margin: 0 10px 0 0"><input type="checkbox" name="tribunais" value="'+data.getValue(i, 0)+'"/>'+data.getValue(i, 0)+'</label>';
                        }
                        document.getElementById('div_tribunais').innerHTML = inputs;
                    });
                };
                
                // Recupera as unidades de medidas
                function getUnidadeMedidas(){
                    var tipoDroga = document.getElementById('tipo_droga').value;
                    if (tipoDroga === ''){
                        alert('em branco');
                    }else{
                        document.getElementById('unidade_medida').innerHTML = '<option>CARREGANDO...</option>';
                        
                        var queryString = encodeURIComponent('SELECT G WHERE E = \''+tipoDroga+'\' AND G IS NOT NULL AND ( M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL)');
                        var query = new google.visualization.Query(
                        'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=0&header=1&tq=' + queryString);
                        query.send(handleResponseUnidadeMedidas);
                    }
                    
                }
                
                // Trata a resposta da consulta do metodo getUnidadesMedidas
                function handleResponseUnidadeMedidas(response) {
                    if (response.isError()) {
                      alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                      return;
                    }

                    var data = response.getDataTable();
                    var unidadeMedidas = data.getDistinctValues('G');
                    
                    var options = '<option><\/option>';
                    for(var i = 0; i < unidadeMedidas.length; i++ ){
                        options += '<option value="'+unidadeMedidas[i]+'">'+unidadeMedidas[i]+'</option>'
                    }
                    document.getElementById('unidade_medida').innerHTML = options;
                }
                
                // Inicia a criacao do Grafico
                function drawChart(){
                    var tipoDroga = document.getElementById('tipo_droga').value;
                    var unidadeMedida = document.getElementById('unidade_medida').value;
                    var qtMinima = document.getElementById('qt_minima').value;
                    var qtMaxima = document.getElementById('qt_maxima').value;
                    var tribunais = document.getElementsByName('tribunais');
                    
                    // Inicia a criacao dos filtros
                    var filtros = '';
                    var numeric = /^\d+$/;
                    if (qtMinima.match(numeric)){
                        filtros += ' AND F >= '+qtMinima;
                    }
                    
                    if (qtMaxima.match(numeric)){
                        filtros += ' AND F <= '+qtMaxima;
                    }
                    
                    var tribunaisArray = [];
                    if (tribunais.length > 0){
                        for (var i = 0; i < tribunais.length; i++){
                            if (tribunais[i].checked){
                                tribunaisArray.push(tribunais[i].value);
                            }
                        }
                    }
                    for (var i = 0; i < tribunaisArray.length; i++){
                        if(i === 0) filtros += ' AND ( ';
                            
                        filtros +=  'B LIKE \''+tribunaisArray[i]+'\'';
                        
                        if(i === tribunaisArray.length-1){
                            filtros += ' ) ';
                        }else{
                            filtros += ' OR ';
                        }
                    }
                    // Termina a criacao dos filtros
                    
                    if (tipoDroga === '' || tipoDroga === 'CARREGANDO...'|| unidadeMedida === '' || unidadeMedida === 'CARREGANDO...'){
                        alert('Selecione a droga/unidade primeiro!');
                    }else{
                        var queryString = encodeURIComponent('SELECT A, B, F, M, N, O WHERE E = \''+tipoDroga+'\' AND G LIKE \''+unidadeMedida+'\' AND ( M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL) '+filtros+' ORDER BY F ');
                        var query = new google.visualization.Query(
                        'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=0&header=1&tq=' + queryString);
                        
                        toggleOverlay();
                        
                        query.send(handleResponseDrawChart);

                    }
                    return false;
                }
                
                // Gera o Grafico com a resposta da funcao drawChart
                function handleResponseDrawChart(response){
                    toggleOverlay();
                    if (response.isError()) {
                        alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                        return;
                    }
                    
                    var unidadeMedida = document.getElementById('unidade_medida').value;
                    var dataResponse = response.getDataTable();
                    var sizeRows = dataResponse.getNumberOfRows();
                    
                    var dataToDraw = new google.visualization.DataTable();
                    
                    dataToDraw.addColumn('number', 'Quantum de aumento');
                    dataToDraw.addColumn('number', 'Quantidade');
                    dataToDraw.addColumn({type:'string',role:'tooltip', p:{html:true}});
                    
                    for(var i = 0; i < sizeRows; i++){
                        var quantumTotal = quantumCalc([dataResponse.getValue(i,3),dataResponse.getValue(i,4),dataResponse.getValue(i,5)]);
                        var tooltip = 'Tribunal: <b>'+ dataResponse.getValue(i,1)+'</b><br/>\
                            Processo: <b>'+dataResponse.getValue(i,0)+'</b><br/>\
                            Quantidade: <b>'+dataResponse.getValue(i,2)+' '+unidadeMedida.toLowerCase()+'</b><br/>\
                            Quantum de aumento: <b>'+quantumTotal+' meses</b>';
                        
                        dataToDraw.addRow([{v:quantumTotal}, {v:dataResponse.getValue(i,2)}, tooltip]);
                    }

                    // Set chart options
                    var options = {
                        title: 'Quantidade X Quantum de Aumento',
                        height: '600',
                        hAxis: {title: 'Quantum de Aumento'},//, minValue: 0, maxValue: 100},
                        vAxis: {title: 'Quantidade'},//, minValue: 0, maxValue: 100},
                        legend: 'none',
                        tooltip: {
                            isHtml: true
                        }
                        
                        //explorer: {
                        //    maxZoomIn: 15,
                        //   maxZoomOut: 0,
                        //    axis: 'vertical',
                        //    keepInBounds: true
                        //}
                    };

                    var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));

                    chart.draw(dataToDraw, options);
                    
                    var table = new google.visualization.Table(document.getElementById('table_div'));
                    table.draw(dataResponse);
                }
                
                // Calcula o total do quantum de aumento
                function quantumCalc(values){
                    var result = 0;
                    //console.log(values);
                    for (var i = 0; i < 3; i++){
                        if(values[i] != null){
                            var value = values[i].split(/a|m|d/);
                            result += (Number(value[0]) * 12) + Number(value[1]) + (Number(value[2])/30);
                        }
                    }
                    //console.log(result);
                    return result;
                }
                
                function toggleOverlay(){
                    var display = document.getElementById('overlay').style.display
                    if (display === 'none'){
                        document.getElementById('overlay').style.display = 'block';
                        document.getElementById('ajax-loading').style.display = 'block';
                    }else{
                        document.getElementById('overlay').style.display = 'none';
                        document.getElementById('ajax-loading').style.display = 'none';
                    }
                }
                
            </script>
    </body>
</html>
