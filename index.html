<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dosimetria da pena</title>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="css/default.css"/>
    </head>
    <body>
        <div id="overlay" style="display:none;"></div>
        <div id="ajax-loading" style="display:none;">
            <img id="img-ajax-loading" src="css/ajax-loading.gif" alt="Loading"/>
        </div>
        <div class="wrap">
            <div class="container">
                <div class="jumbotron well-sm">
                    <h2>2ª CCR</h2>
                </div>
                <form id="formulario" onSubmit='return false;' class="form-horizontal">
                    <div class="form-group">
                        <label for="tipo_grafico" class="col-sm-2">Tipo de gráfico<span class="text-danger">*</span></label>
                        <div class="col-sm-3">
                            <select id="tipo_grafico_select" onChange='beginning();' class="form-control">
                                <option></option>
                                <option value="UNICO">ÚNICO</option>
                                <option value="SOBREPOSTO">SOBREPOSTO</option>
                                <option value="MULTIPLO">MULTIPLO</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tipo_droga" class="col-sm-2">Selecione a droga<span class="text-danger">*</span></label>
                        <div class="col-sm-3">
                            <select id="tipo_droga" onChange='getUnidadeMedidas();' class="form-control">
                                <option></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="unidade_medida" class="col-sm-2">Selecione a unidade de medida<span class="text-danger">*</span></label>
                        <div class="col-sm-3">
                            <select id="unidade_medida" class="form-control">
                                <option></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><small class="text-danger col-sm-12">Campos marcados com * são obrigatórios!</small></div>
                    
                    <fieldset>
                        <legend>Filtros</legend>
                        <div class="form-group">
                            <label for="qt_minima" class="col-sm-2">Quantidade mínima</label>
                            <div class="col-sm-3">
                                <input id="qt_minima" type="number" class="form-control"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="qt_maxima" class="col-sm-2">Quantidade máxima</label>
                            <div class="col-sm-3">
                                <input id="qt_maxima" type="number" class="form-control"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2">Tribunais</label>
                            <div id="div_tribunais" class="col-sm-10"></div>
                        </div>
                    </fieldset>
                </form>
                <div id="primary_buttons" class="row">
                    <div class="col-sm-3 botton-15">
                        <button class="btn btn-primary disabled btn-block">Selecione o tipo de gráfico</button>
                    </div>
                </div>
                <div id="secondary_buttons" class="row">
                </div>
                <div id="chart_1"></div>
                <div id="chart_2"></div>
                <div id="chart_3"></div>
                <div id="chart_4"></div>
                <div id="chart_5"></div>
                <div id="chart_table"></div>
            </div> <!-- FIm div container -->
        </div> <!-- FIm div wrap -->
        <div class="footer">
            <div class="container text-center">
                Ministério Público Federal<br/>
                Procuradoria da República no Município de Cachoeiro de Itapemirim/ES<br/>
                Desenvolvido por <a href="mailto:danielgomes@mpf.mp.br">Daniel da Cruz Gomes</a>
            </div>
        </div>
            <script type="text/javascript">
                document.getElementById('tipo_grafico_select').value = '';
                document.getElementById('tipo_grafico_select').disabled = false;
                var tipoGrafico = '';
                var forms = [];
                var dados = {};
                
                // Carrega a biblioteca de visualização do google
                google.load("visualization", "1", {'packages':['corechart', 'table']});
                // Apos o carregamento executa a funcao
                //google.setOnLoadCallback();
                
                function getDivButtons(content){
                    return '<div class="col-sm-2 botton-15">'+content+'</div>'
                }
                
                function getButtons(content, order, action){
                    action = action || 'create';
                    var actions = {create: 'createChart('+order+');', load: 'loadChart('+order+');', clean: 'cleanChart('+order+');'};
                    var classe = {1: 'primary', 2: 'success', 3: 'danger', 4: 'warning', 5: 'info'};
                    return '<button class="btn btn-'+classe[order]+' btn-block" onClick="'+actions[action]+'">'+content+'</button>';
                }
                
                // Recupera as drogas que constam na planilha
                function beginning(){
                    var tipoGraficoSelect = document.getElementById('tipo_grafico_select');
                    tipoGrafico = tipoGraficoSelect.value;
                    
                    tipoGraficoSelect.disabled = true;
                    
                    var primaryButtons = '';
                    var secondaryButtons = '';
  
                    if (tipoGrafico === 'UNICO'){
                        primaryButtons = getDivButtons(getButtons('Gerar Gráficos', 1));
                    }else if (tipoGrafico === 'SOBREPOSTO' || tipoGrafico === 'MULTIPLO'){
                        var total = tipoGrafico === 'SOBREPOSTO' ? 2 : 5;
                        for (var i = 1; i <= total; i++){
                            primaryButtons += getDivButtons(getButtons('Gerar Gráfico '+i, i));;
                            secondaryButtons += getDivButtons(getButtons('Ler Dados', i, 'load') + (tipoGrafico === 'MULTIPLO' ? getButtons('Limpar Gráfico '+i, i, 'clean'): ''));
                        }
                    }else{
                        return false;
                    }
                    
                    document.getElementById('primary_buttons').innerHTML = primaryButtons;
                    document.getElementById('secondary_buttons').innerHTML = secondaryButtons;
                    
                    document.getElementById('tipo_droga').innerHTML = '<option>CARREGANDO...</oprion>';
                    
                    var queryDrogas = new google.visualization.Query(
                    'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=1548055939');
                    queryDrogas.send(function(response){
                        if (response.isError()) {
                            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                            return;
                        }

                        var data = response.getDataTable();
                        var numRows = data.getNumberOfRows();
                        var options = '<option><\/option>';
                        for(var i = 0; i < numRows; i++ ){
                            options += '<option value="'+data.getValue(i, 0)+'">'+data.getValue(i, 0)+'</option>'
                        }
                        document.getElementById('tipo_droga').innerHTML = options;
                    });
                    
                    var queryTribunais = new google.visualization.Query(
                    'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=1195586804');
                    queryTribunais.send(function(response){
                        if (response.isError()) {
                            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                            return;
                        }

                        var data = response.getDataTable();
                        var numRows = data.getNumberOfRows();
                        var inputs = '';
                        for(var i = 0; i < numRows; i++ ){
                            inputs += '<label class="checkbox-inline" style="margin: 0 10px 0 0"><input type="checkbox" name="tribunais" value="'+data.getValue(i, 0)+'"/>'+data.getValue(i, 0)+'</label>';
                        }
                        document.getElementById('div_tribunais').innerHTML = inputs;
                    });
                };
                
                function saveForm(order){
                    var form = {tipoDroga: {},unidadeMedida: {}, qtMinima: {}, qtMaxima: {}, tribunais: {}};
                    form.tipoDroga.innerHtml = document.getElementById('tipo_droga').innerHTML;
                    form.tipoDroga.value = document.getElementById('tipo_droga').value;
                    form.unidadeMedida.innerHtml = document.getElementById('unidade_medida').innerHTML;
                    form.unidadeMedida.value = document.getElementById('unidade_medida').value;
                    form.qtMinima.value = document.getElementById('qt_minima').value;
                    form.qtMaxima.value = document.getElementById('qt_maxima').value;
                    
                    form.tribunais.innerHtml = document.getElementById('div_tribunais').innerHTML;
                    form.tribunais.values = [];
                    
                    var tribunais = document.getElementsByName('tribunais');
                    if (tribunais.length > 0){
                        for (var i = 0; i < tribunais.length; i++){
                            if (tribunais[i].checked){
                                form.tribunais.values.push(tribunais[i].value);
                            }
                        }
                    }
                    forms[order] = form;
                }
                
                // Recupera as unidades de medidas
                function getUnidadeMedidas(){
                    var tipoDroga = document.getElementById('tipo_droga').value;
                    if (tipoDroga === ''){
                        alert('em branco');
                    }else{
                        document.getElementById('unidade_medida').innerHTML = '<option>CARREGANDO...</option>';
                        
                        var queryString = encodeURIComponent('SELECT G WHERE E = \''+tipoDroga+'\' AND G IS NOT NULL AND ( M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL)');
                        var query = new google.visualization.Query(
                        'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=0&header=1&tq=' + queryString);
                        query.send(handleResponseUnidadeMedidas);
                    }
                    
                }
                
                // Trata a resposta da consulta do metodo getUnidadesMedidas
                function handleResponseUnidadeMedidas(response) {
                    if (response.isError()) {
                      alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                      return;
                    }

                    var data = response.getDataTable();
                    var unidadeMedidas = data.getDistinctValues('G');
                    
                    var options = '<option><\/option>';
                    for(var i = 0; i < unidadeMedidas.length; i++ ){
                        options += '<option value="'+unidadeMedidas[i]+'">'+unidadeMedidas[i]+'</option>'
                    }
                    document.getElementById('unidade_medida').innerHTML = options;
                }
                
                
                function loadChart(order){
                    
                    if(typeof forms[order] === 'undefined'){
                        alert('Não existem dados a serem carregados!');
                    }else{
                        form = forms[order];
                        document.getElementById('tipo_droga').innerHTML = form.tipoDroga.innerHtml;
                        document.getElementById('tipo_droga').value = form.tipoDroga.value;
                        document.getElementById('unidade_medida').innerHTML = form.unidadeMedida.innerHtml;
                        document.getElementById('unidade_medida').value = form.unidadeMedida.value;
                        document.getElementById('qt_minima').value = form.qtMinima.value;
                        document.getElementById('qt_maxima').value = form.qtMaxima.value;
                        
                        document.getElementById('div_tribunais').innerHTML = form.tribunais.innerHtml;
                        
                        var tribunais = document.getElementsByName('tribunais');
                        if (tribunais.length > 0){
                            for (var i = 0; i < tribunais.length; i++){
                                if(form.tribunais.values.indexOf(tribunais[i].value) > -1){
                                    tribunais[i].checked = 'checked';
                                }
                            }
                        }
                    }
                }
                
                function cleanChart(order){
                    if (tipoGrafico === 'SOBREPOSTO'){
                        if(order === 1){
                            
                        }
                    }
                    delete(forms[order]);
                    document.getElementById('chart_'+order).innerHTML = '';
                }
                
                // Inicia a criacao do Grafico
                function createChart(order){
                    saveForm(order);
                    
                    var tipoDroga = forms[order].tipoDroga.value;
                    var unidadeMedida = forms[order].unidadeMedida.value;
                    var qtMinima = forms[order].qtMinima.value;
                    var qtMaxima = forms[order].qtMaxima.value;
                    var tribunais = forms[order].tribunais.values;
                    
                    // Inicia a criacao dos filtros
                    var filtros = '';
                    var numeric = /^\d+$/;
                    if (qtMinima.match(numeric)){
                        filtros += ' AND F >= '+qtMinima;
                    }
                    
                    if (qtMaxima.match(numeric)){
                        filtros += ' AND F <= '+qtMaxima;
                    }
                    
                    for (var i = 0; i < tribunais.length; i++){
                        if(i === 0) filtros += ' AND ( ';
                            
                        filtros +=  'B LIKE \''+tribunais[i]+'\'';
                        
                        if(i === tribunais.length-1){
                            filtros += ' ) ';
                        }else{
                            filtros += ' OR ';
                        }
                    }
                    // Termina a criacao dos filtros
                    
                    if (tipoDroga === '' || tipoDroga === 'CARREGANDO...'|| unidadeMedida === '' || unidadeMedida === 'CARREGANDO...'){
                        alert('Selecione a droga/unidade primeiro!');
                    }else{
                        var queryString = encodeURIComponent('SELECT A, B, F, M, N, O WHERE E = \''+tipoDroga+'\' AND G LIKE \''+unidadeMedida+'\' AND ( M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL) '+filtros+' ORDER BY F ');
                        var query = new google.visualization.Query(
                        'https://docs.google.com/spreadsheets/d/1sa1IoM5qmSOPmUoo6dC-YK6R1z__ysJ7aC2gq_azae4/gviz/tq?gid=0&header=1&tq=' + queryString);
                        
                        toggleOverlay();
                        
                        query.send(function (response){
                            handleResponseDrawChart(response, order);
                        });

                    }
                    return false;
                }
                
                // Gera o Grafico com a resposta da funcao drawChart
                function handleResponseDrawChart(response, order){
                    
                    toggleOverlay();
                    if (response.isError()) {
                        alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                        return;
                    }
                    
                    dados[order] = response.getDataTable();
                    
                    var dataToDraw = new google.visualization.DataTable();
                    
                    dataToDraw.addColumn('number', 'Quantum de aumento');
                    dataToDraw.addColumn('number', 'Gráfico 1');
                    dataToDraw.addColumn({type:'string',role:'tooltip', p:{html:true}});
                    
                    if (tipoGrafico === 'SOBREPOSTO'){
                        dataToDraw.addColumn('number', 'Gráfico 2');
                        dataToDraw.addColumn({type:'string',role:'tooltip', p:{html:true}});
                    }
                    
                    populateData(dataToDraw, order);
                    
                    if (tipoGrafico === 'SOBREPOSTO' && order === 1 && (typeof dados[2] != 'undefined')){
                        populateData(dataToDraw, 2);
                    }else if (tipoGrafico === 'SOBREPOSTO' && order === 2 && (typeof dados[1] != 'undefined')){
                        populateData(dataToDraw, 1);
                    }
                    
                    var title = '';
                    
                    if (tipoGrafico == 'UNICO' || tipoGrafico == 'SOBREPOSTO'){
                        title = 'Quantidade X Quantum de Aumento';
                    }else{
                        title = 'Gráfico '+order;
                    }
                    
                    var colorsButtons = ['#337ab7','#5cb85c','#d9534f','#f0ad4e','#5bc0de'];
                    
                    // Set chart options
                    var options = {
                        title: title,
                        height: '600',
                        hAxis: {title: 'Quantum de Aumento'},//, minValue: 0, maxValue: 100},
                        vAxis: {title: 'Quantidade'},//, minValue: 0, maxValue: 100},
                        //legend: 'none',
                        tooltip: {
                            isHtml: true
                        },
                        colors: tipoGrafico == 'MULTIPLO' ? [colorsButtons[order-1]]:colorsButtons
                        
                        //explorer: {
                        //    maxZoomIn: 15,
                        //   maxZoomOut: 0,
                        //    axis: 'vertical',
                        //    keepInBounds: true
                        //}
                    };
                    
                    if (tipoGrafico !== 'SOBREPOSTO'){
                        options.legend = 'none';
                        var chart = new google.visualization.ScatterChart(document.getElementById('chart_'+order));
                    }else{
                        var chart = new google.visualization.ScatterChart(document.getElementById('chart_1'));
                    }

                    chart.draw(dataToDraw, options);
                    
                    if (tipoGrafico === 'UNICO'){
                        var table = new google.visualization.Table(document.getElementById('chart_table'));
                        table.draw(dados[order]);
                    }
                }
                
                function populateData(dataToDraw, order){
                    
                    var rowsLength = dados[order].getNumberOfRows();
                    for(var i = 0; i < rowsLength; i++){
                        var quantumTotal = quantumCalc([dados[order].getValue(i,3),dados[order].getValue(i,4),dados[order].getValue(i,5)]);
                        var tooltip = 'Tribunal: <b>'+ dados[order].getValue(i,1)+'</b><br/>\
                            Processo: <b>'+dados[order].getValue(i,0)+'</b><br/>\
                            Quantidade: <b>'+dados[order].getValue(i,2)+' '+forms[order].unidadeMedida.value.toLowerCase()+'</b><br/>\
                            Quantum de aumento: <b>'+quantumTotal+' meses</b>';
                            
                            
                        if (tipoGrafico == 'SOBREPOSTO'){
                            if (order === 1){
                                dataToDraw.addRow([{v:quantumTotal}, {v:dados[order].getValue(i,2)}, tooltip, null, null]);
                            }else{
                                dataToDraw.addRow([{v:quantumTotal}, null, null, {v:dados[order].getValue(i,2)}, tooltip]);
                            } 
                        }else{
                            dataToDraw.addRow([{v:quantumTotal}, {v:dados[order].getValue(i,2)}, tooltip]);
                        }
                    }
                }
                
                // Calcula o total do quantum de aumento
                function quantumCalc(values){
                    var result = 0;

                    for (var i = 0; i < 3; i++){
                        if(values[i] != null){
                            var value = values[i].split(/a|m|d/);
                            result += (Number(value[0]) * 12) + Number(value[1]) + (Number(value[2])/30);
                        }
                    }

                    return result;
                }
                
                function toggleOverlay(){
                    var display = document.getElementById('overlay').style.display
                    if (display === 'none'){
                        document.getElementById('overlay').style.display = 'block';
                        document.getElementById('ajax-loading').style.display = 'block';
                    }else{
                        document.getElementById('overlay').style.display = 'none';
                        document.getElementById('ajax-loading').style.display = 'none';
                    }
                }
                
            </script>
    </body>
</html>
